#![allow(dead_code, unused_variables)]
// #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")] // hide console window on Windows in release

use instally_core::{workloads::installer::{Product, InstallerOptions}, factory::WorkloadType};

mod factory;
mod app;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let rust_log = std::env::var("RUST_LOG").unwrap_or("info".into()); 
    std::env::set_var("RUST_LOG", rust_log);  
    env_logger::init();

    let payload_result = quick_xml::de::from_str(PAYLOAD.strip_prefix("###/PAYLOAD/###").unwrap());
    let product = match payload_result {
        Ok(r) => {
            log::info!("Payload Product is valid. Using it.");
            r
        },
        Err(_) => {
            log::info!("Payload Product is not valid. Using dummy.");

            //TODO: strip this from production
            Product { // prototype 'Product' structure
                name: "Tutucu".to_owned(),
                publisher: "liteware".to_owned(),
                product_url: "https://liteware.io".to_owned(),
                control_script: "none".to_owned(),
                target_directory: "C:\\Users\\doquk\\AppData\\Roaming\\liteware.io\\Tutucu".to_owned(),
                repository: "https://cdn.liteware.xyz/instally/tutucu/release/".to_owned()
            }
        }
    };

    log::info!("Payload xml: {:?}", quick_xml::se::to_string(&product));
    instally_core::helpers::process::terminate_processes_under_folder(&product.target_directory)
        .expect("Failed to terminate processes under target directory!");

    let args = parse_args(&product).await;

    _ = factory::run(
        &product,
        WorkloadType::Installer(InstallerOptions::default()),
        true
    ).handle.await;

    Ok(())
}


// could not come with something more stupid
const PAYLOAD: &str = "###/PAYLOAD/###<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><Product><Name>Tutucu</Name><Publisher>liteware</Publisher><ProductUrl>https://liteware.io</ProductUrl><ControlScript>none</ControlScript><TargetDirectory>C:\\Users\\doquk\\AppData\\Roaming\\liteware.io\\Tutucu</TargetDirectory><Repository>https://cdn.liteware.xyz/instally/tutucu/release/</Repository></Product>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ";
